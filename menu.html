<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>HANK | Menu</title> 
	<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="css/index.css" />
	<meta name="msapplication-tap-highlight" content="no" />
	<link rel="stylesheet" type="text/css" href="inc/jquery.mobile-1.4.2.min.css" /> 
	<link rel="stylesheet" type="text/css" href="inc/jquery.mobile.icons-1.4.2.min.css" /> 
	<link rel="stylesheet" type="text/css" href="inc/jquery.mobile.structure-1.4.2.min.css" /> 
	<link rel="stylesheet" type="text/css" href="inc/jquery.mobile.theme-1.4.2.min.css" />
	<link rel="stylesheet" type="text/css" href="themes/hnk.css" />
	<link rel="stylesheet" href="inc/pickadate/lib/themes/default.css" id="theme_base">
	<link rel="stylesheet" href="inc/pickadate/lib/themes/default.date.css" id="theme_date">
	<link rel="stylesheet" href="inc/pickadate/lib/themes/default.time.css" id="theme_time">
	<script type="text/javascript" src="js/index.js"></script>

</head>
<body>
	<div data-role="page" id="menu" data-theme="a">
		<div data-role="header" data-theme="a">

			<div data-role="header">
				<a href="index.html" rel="external" data-transition="slide" data-icon="back">Back</a>
				<h1 id="main_title">Menu</h1>
				<a href="#cart" rel="external" data-transition="slidedown" data-icon="grid"><span class="simpleCart_quantity"></span> items | <span class="simpleCart_grandTotal"></span></a>
			</div>
			<div id="navbar" data-role="navbar">
				<ul>
					<li><a data-icon="arrow-d" onclick="show('menu_choose',0);" href="#menu">Menus</a></li>
					<li><a data-icon="arrow-d" onclick="show(1,0);" href="#menu">Burgers</a></li>
					<li><a data-icon="arrow-d" onclick="show(2,0);" href="#menu">Side</a></li>
					<li><a data-icon="arrow-d" onclick="show(3,0);" href="#menu">Drinks</a></li>
					<li><a data-icon="arrow-d" onclick="show(4,0);" href="#menu">Desserts</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /header -->
		<div id="content" data-role="content">
			<div id="main">Please choose your items</div>
		</div>
		<div data-role="footer">
			<h4>footer</h4>
		</div>
	</div>
	<div data-role="page" id="cart" data-theme="a">
		<div data-role="header">
			<a href="#menu" rel="external" data-transition="slide" data-icon="back">Menu</a>
			<h1 id="main_title">Cart</h1>
		</div><!-- /header -->
		<div id="content" data-role="content">
			<div class="simpleCart_items"></div>
			<p></p>
			grandTotal : <span class="simpleCart_grandTotal"></span><br />
			Total : <span class="simpleCart_total"></span>
			<br /> 

			<span id="nbmenu1"></span><span id="nbmenu2"></span>
			<br /> 

			<p></p>
			<a href="javascript:;" class="simpleCart_empty" data-role="button" data-icon="delete" data-inline="true">Empty cart</a>
			<a href="#pickup" rel="external" data-transition="slide" data-role="button" data-icon="arrow-r" data-inline="true">Checkout</a>
		</div>
	</div>
	<div data-role="page" id="pickup" data-theme="a">
		<div data-role="header">
			<a href="#cart" data-transition="slide" data-icon="back">Cart</a>
			<h1 id="main_title">Pickup</h1>
			<a href="#cart" rel="external" data-transition="slidedown" data-icon="grid"><span class="simpleCart_quantity"></span> items | <span class="simpleCart_grandTotal"></span></a>
		</div>
		<div id="content" data-role="content">
			<form id="order" name="order">
				<p>When do you want to pick it up ?</p>
				<input id="datepicker" class="datepicker" type="text" required/>
				<p></p>
				<input id="timepicker" class="timepicker" type="text" required/>   
				<p></p>
				Our restaurant is open from xx to xx from Monday to Saturday.
				<p></p>
				<label for="phone">Your phone number</label>   
				<input name="phone" id="phone" value="" required/>
				<p></p>
				<label for="email">Your email </label>   
				<input name="email" id="email" value="" required/>
				<p></p>
				<label for="name">Your name </label>   
				<input name="name" id="name" value="" required/>
				<p></p>
				Total order : <span class="simpleCart_grandTotal"></span>
				<p></p>
				<input type="submit" value="Checkout" onclick="goCheckout();" rel="external" data-transition="slide" data-icon="arrow-r" data-role="button" data-inline="true"/>
			</form>
		</div>
	</div>

	<script type="text/javascript" src="inc/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="inc/jquery.mobile-1.4.2.min.js"></script>
	<script type="text/javascript" src="inc/simpleCart.min.js"></script>
	<script type="text/javascript" src="inc/jquery.validate.min.js"></script>
	<script type="text/javascript" src="inc/hnk.js"></script>
	<script src="inc/pickadate/lib/picker.js"></script>
	<script src="inc/pickadate/lib/picker.date.js"></script>
	<script src="inc/pickadate/lib/picker.time.js"></script>
	<script src="inc/pickadate/lib/legacy.js"></script>
	<script src="inc/pickadate/demo/scripts/demo.js"></script>
	<script src="inc/pickadate/demo/scripts/rainbow.js"></script>
	<script type="text/javascript">	

	function returnObj(str) {
		return eval('{' + str + '}');
	}

	function setTimepicker(hours) {
		picker_time.render(true);
		//mandatory to empty the object 
		picker_time.set('disable', true) 
		picker_time.set('enable', true)
		//and then set the disable time again
		picker_time.set({
			disable: [
			{ from: hours.f1 , to: hours.t1 }, 
			{ from: hours.f2 , to: hours.t2 },
			{ from: hours.f3 , to: hours.t3 }
			]
		})
	}

	/** 
	disabled_day : syntax : 0 = Sun, 1 = Mon ... - for many : 1,2...
	max_order_days : nb of days max to show from now
	min_time : minimum opening hours
	max_time : maximum opening hours
	**/
	
	var products = JSON.parse(localStorage["products"]);
	var params = JSON.parse(localStorage["params"]);
	var min_time = returnObj(params.min_time);
	var max_time = returnObj(params.max_time);

	$('#timepicker').val('Please select a date');
	$('.timepicker').textinput({ disabled: true });

	function getHours(day) {
		var hours;		
		switch (day) {
			case 'Mon':
			hours = {f1:returnObj(params.opening_mon_f1), t1:returnObj(params.opening_mon_t1), f2:returnObj(params.opening_mon_f2), t2:returnObj(params.opening_mon_t2), f3:returnObj(params.opening_mon_f3), t3:returnObj(params.opening_mon_t3)};
			break;
			case 'Tue':
		    hours = {f1:returnObj(params.opening_tue_f1), t1:returnObj(params.opening_tue_t1), f2:returnObj(params.opening_tue_f2), t2:returnObj(params.opening_tue_t2), f3:returnObj(params.opening_tue_f3), t3:returnObj(params.opening_tue_t3)};
			break;
			case 'Wed':
			hours = {f1:returnObj(params.opening_wed_f1), t1:returnObj(params.opening_wed_t1), f2:returnObj(params.opening_wed_f2), t2:returnObj(params.opening_wed_t2), f3:returnObj(params.opening_wed_f3), t3:returnObj(params.opening_wed_t3)};
			break;
			case 'Thu':
			hours = {f1:returnObj(params.opening_thu_f1), t1:returnObj(params.opening_thu_t1), f2:returnObj(params.opening_thu_f2), t2:returnObj(params.opening_thu_t2), f3:returnObj(params.opening_thu_f3), t3:returnObj(params.opening_thu_t3)};
			break;
			case 'Fri':
			hours = {f1:returnObj(params.opening_fri_f1), t1:returnObj(params.opening_fri_t1), f2:returnObj(params.opening_fri_f2), t2:returnObj(params.opening_fri_t2), f3:returnObj(params.opening_fri_f3), t3:returnObj(params.opening_fri_t3)};
			break;
			case 'Sat':
			hours = {f1:returnObj(params.opening_sat_f1), t1:returnObj(params.opening_sat_t1), f2:returnObj(params.opening_sat_f2), t2:returnObj(params.opening_sat_t2), f3:returnObj(params.opening_sat_f3), t3:returnObj(params.opening_sat_t3)};
			break;
			case 'Sun':
			hours = {f1:returnObj(params.opening_sun_f1), t1:returnObj(params.opening_sun_t1), f2:returnObj(params.opening_sun_f2), t2:returnObj(params.opening_sun_t2), f3:returnObj(params.opening_sun_f3), t3:returnObj(params.opening_sun_t3)};
			break;
		}
		return hours;
	}

var $input_time = $('.timepicker').pickatime({
	formatLabel: 'H:i',
	formatSubmit: 'H:i',
	format: 'H:i',
	interval: returnObj(params.max_order_days),
	min: returnObj(params.min_time),
	max: returnObj(params.max_time),
	editable: false
});

var picker_time = $input_time.pickatime('picker')
var $input = $('.datepicker').pickadate({

	onSet: function() {
		picker = this;
		pick_date_obj = picker.get('select', 'ddd');
		if(pick_date_obj) { 
			$('.timepicker').textinput({ disabled: false });
			$('#timepicker').val('Please select a time');
		} else {
			$('.timepicker').textinput({ disabled: true });
			$('#timepicker').val('Please select a date');
		}
		picker_time.render(true);
		setTimepicker(getHours(pick_date_obj));
	},

	format: 'yyyy-mm-dd',
	formatSubmit: 'yyyy-mm-dd',
	firstDay: 1,
	min: true,
	max: returnObj(params.max_order_days),
	editable: false, 
	'disable': [ returnObj(params.disabled_day) ]
});	

simpleCart({
	cartColumns: [
	{ view:'image' , attr:'thumb', label: false},            
	{view : function(item, column){
				line = item.get('name');
				if(item.get('mtype') >=1000 ) {
					line = line + "<br />Burger: " + item.get('burger');
					line = line + "<br />Drink: " + item.get('drink');
					line = line + "<br />Side: " + item.get('side');
					if(item.get('dessert') >0 ) line = line + "<br />Dessert: " + item.get('dessert');
				}
				if(item.get('friessauce') >0 ) line = line + "<br />Sauce: " + item.get('friessauce');
				if(item.get('extracheese') >0 ) line = line + "<br />+ Cheese";
				if(item.get('extragf') >0 ) line = line + "<br />+ Gluten free";
	            return line;
	},
	            attr : 'Products', label: "Products"},
	{ view: "currency", attr: "price", label: "Price"},
	{ view: "increment", label: false},
	{ attr: "quantity", label: "Qty"},
	{ view: "decrement", label: false},
	{ view: "currency", attr: "total", label: "SubTotal" },
	{ attr: "mtype", label: "mType"},
	{ attr: "mid", label: "mId"}, 
	{ view: "remove", text: "Remove", label: false}
	],
	cartStyle: "table",
	checkout: {
		type: "PayPal" ,
		success: params.url_paypal_success, 
		cancel: params.url_paypal_cancel,
		sandbox: true,
		email: params.email_paypal
	},
	currency: "EUR",
	data: {},
	language: "english-us",
	//to avoid seeing it on paypal
	excludeFromCheckout: ['thumb', 'mtype', 'burger', 'extracheese', 'extragf', 'side', 'friessauce', 'drink', 'dessert', 'mid', 'mtype'],
	shippingCustom: null,
	shippingFlatRate: 0,
	shippingQuantityRate: 0,
	shippingTotalRate: 0,
	taxRate: 0,
	taxShipping: false,
	beforeAdd            : null,
	afterAdd            : null,
	load                : null,
	beforeSave        : null,
	afterSave            : null,
	update            : null,
	ready            : null,
	checkoutSuccess    : null,
	checkoutFail        : null,
	beforeCheckout        : null,
	beforeRemove : null
});

function getExtraPrice(extra) {
	var extra_price = extra.split("_"); 
	return parseFloat(extra_price[1]);
}

function show(type, menu_type) {
	var contain = '';

	var cheese_select = 'Cheese : <select id="item_extracheese" name="item_extracheese" class="item_extracheese"><option value="0">without</option><option value="1">with</option></select> + ' + params.extracheese_price + '€<br/>';	
	var gf_select = 'Gluten free bread : <select id="item_extragf" name="item_extragf" class="item_extragf"><option value="0">without</option><option value="1">with</option></select> + ' + params.extragf_price + '€<br/>';

	if(type == 'menu_choose') {
		contain = '<a onclick="show(\'menu_create\',1);" href="#">MENU ' + params.menu_1_name + '</a> <br /> \
		<a onclick="show(\'menu_create\',2);" href="#">MENU ' + params.menu_2_name + '</a> <br />';
	}
	if(type == 'menu_create') {
		var menu_name	= params.menu_1_name;
		var menu_price	= params.menu_1_price;
		var mtype		= 1000;

		if(menu_type == 2) {
			menu_name	= params.menu_2_name;
			menu_price	= params.menu_2_price;
			var mtype		= 1001;

		}
		contain = '<div class="simpleCart_shelfItem"> \
		<img class="item_thumb" src="tmp.png"><br /> \
		<h2 class="item_name">Menu ' + menu_name + '</h2><br />MTYPE: <span class="item_mtype">' + mtype + '</span><br />';
		contain = contain + '<span class="item_price">' + menu_price + '</span>€<br />';

		contain = contain + 'BURGER : <select name="item_burger" class="item_burger">';
		$.each(products, function(key, val) {
			var extra = '';
			if(val.att) {
				var extra_price = getExtraPrice(val.att); 
				var extra = '+' + extra_price + '€';
			}
			if(val.type == 1) contain = contain + '<option value="' + val.id + '">' + val.name + ' ' + extra + '</option>';	
		});
		contain = contain + '</select><br />';
		contain = contain + cheese_select;
		contain = contain + gf_select;

		contain = contain + '<br />SIDE : <select id="item_side" name="item_side" class="item_side">';
		$.each(products, function(key, val) { 
			if(val.type == 2) contain = contain + '<option value="' + val.id + '">' + val.name + '</option>';
		});
		
		contain = contain + '</select> | Sauces : ' + selectSauce(100)  + '<br />';
		
		contain = contain + 'DRINK : <select name="item_drink" class="item_drink">';
		$.each(products, function(key, val) {
			var extra = '';
			if(val.att) {
				var extra_price = val.att.split("_"); 
				var extra = '+' + extra_price[1] + '€';
			}
			if(val.type == 3) contain = contain + '<option value="' + val.id + '">' + val.name + ' ' + extra + '</option>';		
		});
		contain = contain + '</select><br />';

		if(menu_type == 2) {
			contain = contain + 'DESSERT : <select name="item_dessert" class="item_dessert">';
			$.each(products, function(key, val) {
				if(val.type == 4) contain = contain + '<option value="' + val.id + '">' + val.name + '</option>';
			});
			contain = contain + '</select><br />';
		}	

		contain = contain + '<a class="item_add" href="javascript:;"> Add to Cart </a> </div>';
		 
	} else {

		$.each(products, function(key, val) {
			if(val.type == type) {
				contain = contain + '<div class="simpleCart_shelfItem"> \
				<h2 class="item_name">' + val.name + '</h2> ' + val.detail + ' \
				<span class="item_price">' + val.price + '</span>€ \
				<img class="item_thumb" src="' + val.image + '"><br /> \
				<input type="hidden" class="item_mtype" name="item_mtype" value="' + val.type + '" > \
				<input type="hidden" class="item_mid" name="item_mid" value="' + val.id + '" ><br/>';

				if(val.type == 1) {
					contain = contain + cheese_select;
					contain = contain + gf_select;
				}
				contain = contain + 'Sauces : ' + selectSauce(100)  + '<br />';
				contain = contain + '<a class="item_add" href="javascript:;"> Add to Cart </a> </div>';
			}
		});
	}
	document.getElementById("main").innerHTML = contain;
};

function selectSauce(type) {	
	var txt = '<select id="item_friessauce" name="item_friessauce" class="item_friessauce"><option value="' + 0 + '">none</option>';
	$.each(products, function(key, val) { 
		if(val.type == type) txt = txt + '<option value="' + val.id + '">' + val.name + '</option>';
	});
	txt = txt + '</select>';
	return txt;
}

//add extras to cart
simpleCart.bind( 'beforeAdd' , function( item )
{
	var plus_price = 0;
	if( item.get( 'extracheese' ) == 1 ) {			
		plus_price = plus_price + parseFloat(params.extracheese_price);
	}
	if( item.get( 'extragf' ) == 1 ) {			
		plus_price = plus_price + parseFloat(params.extragf_price);
	}
	if( item.get( 'mtype' ) >= 1000 ) {
		var drink_id = item.get( 'drink' );
		products_vars = products[drink_id];
		products_att = products_vars['att'];
		if(products_att) {
			extra_price = getExtraPrice(products_att);
			plus_price = parseFloat(plus_price) + parseFloat(extra_price);
		}
	}
	item.price( item.get( 'price' ) + parseFloat(plus_price) );
}
);

function goCheckout() {

	var validator = $( "#order" ).validate({	
		submitHandler: function(form) {	
		}, 
		errorClass: "form-invalid",
		validClass: "form-success",
		rules: {
			datepicker: {
				required: true,
				minlength: 3,
				maxlength: 30,
				date: true
			},
			timepicker: {
				required: true,
				minlength: 3,
				maxlength: 6,
			},		
			name: {
				required: true,
				minlength: 2,
				maxlength: 30
			},
			email: {
				required: true,
				email: true,
				minlength: 3,
				maxlength: 50
			},
			phone: {
				required: true,
				minlength: 5,
				maxlength: 30
			}
		}
	});
	
	validator.form();
	var errors = validator.numberOfInvalids();
	if(errors > 0) {
	} else {
		var tnxid = getTnxId();
	}
}

function getTnxId() {

	var url=params.payment_init_url;
	var cart=JSON.parse(localStorage["simpleCart_items"]);
	url = url + 'format/json/?callback=?';
	
	//send payment info to remote server
	var info={"email":$( "#email" ).val(), 
	"name": $( "#name" ).val(), 
	"phone": $( "#phone" ).val(),
	"date": $( "#datepicker" ).val(),
	"amount": simpleCart.grandTotal(),
	"time": $( "#timepicker" ).val()};
	var topost = {cart : cart, info : info};
	
	$.ajax({
		url : url,
		type: "POST",
		data: JSON.stringify(topost),
		success: function(response, textStatus, jqXHR)
		{	
			if(response.tnxid.substr(0,4) == 'TNX-') {	
				simpleCart.bind( 'beforeCheckout' , function( data ){
					//send tnxid to payment platform 
					data.custom			= response.tnxid;
					//for paypal autofill
					data.email			= $( "#email" ).val();
					data.first_name		= $( "#name" ).val();
					data.night_phone_a	= $( "#phone" ).val();
				});
				//if timestamp from server now and get data exeed x hours, get error and resdirect to home
				ts = localStorage["ts"];
				var tstest = response.ts - ts;
				if(tstest > 10800) {
					alert('Your basket is too old, please go back to home and make a new one...');
					window.location.replace("index.html");
				} else {
					simpleCart.checkout();
				}				
			} else {
				alert('Communication server fail, are you connected to the Internet?');
			}
		},
		error: function(jqXHR, textStatus, errorThrown)
		{
			alert('Communication server fail, are you connected to the Internet?');
		}
	});
}

ts = localStorage["ts"];
$("#navbar").parent().hide();
//no timestamp set from index page = error message
if (isNaN(ts))  { 
	alert('Communication server fail, are you connected to the Internet?');
} else {
	enableDiv("#navbar");
}
</script>
</body>
</html>